; the shell of this code taken from "Apple //gs Assembly Language;   Programming" by Leo J. Scanlon.; MODEL initializes and shuts down the major tool sets in the proper order.CH             gequ $00VC             gequ $02BASL           gequ $04   ; this var is 3-4 bytes long.BASH           gequ $05KEYBOARD       GEQU $E0C000KEYSTROBE      GEQU $E0C010               absaddr on               MCOPY Liphe.macrosModel          START               using GlobalData;---------------------------------------------------------;; Global equates used throughout the programScreenMode     gequ $00                ;320 mode, no fillMaxX           gequ 320                ;320 mode for event manager               phk                     ;make data bank=               plb                     ; program bank               jsr InitStuff               bcs AllDone             ;quit if init fails               jsr EventLoop           ;run the applicationAllDone        anop                    ;all is done, shut down               _SFShutDown               _DeskShutDown               _MenuShutDown               _WindShutDown               _CtlShutDown               _DialogShutdown               _EMShutDown               _LEShutDown               _QDShutDown               _MTShutDown               PushWord MyID               _DisposeAll               PushWord MyID               _MMShutDown               _TLShutDown               _Quit QuitParams               brk $F0               END;;      Global Data;GlobalData     DATAQuitParams     dc i4'0'                ;return to caller               dc i'$4000'             ;make program restartable in memoryMyID           ds 2ToolTable      dc i'NumTools'          ;no of tool sets in this table               dc i'4,$0100'           ;quickdraw               dc i'5,$0100'           ;Desk Manager               dc i'6,$0100'           ;Event Manager               dc i'14,$0100'          ;window manager               dc i'15,$0100'          ;menu manager               dc i'16,$0100'          ;control manager               dc i'20,$0100'          ;line edit               dc i'21,$0100'          ;dialog manager               dc i'$17,$0100'         ;Standard File operationsTTEnd          anopTableSize      equ TTEnd-ToolTable-2NumTools       equ TableSize/4VolNotFound    equ $45                 ;prodos errorAboutWinPtr    dc i4'0'UnivPtr        dc i4'0'                ;cosmos windowrect pointerQuitFlag       dc i2'0'                ;quit flag???TaskRecord     anopEventWhat      ds 2EventMessage   ds 4EventWhen      ds 4EventWhere     ds 4EventModifiers ds 2TaskData       ds 4TaskMask       dc i4'$1FFF'PaintColor     ds 2Thingy         ds 2               END;;      InitStuff;InitStuff      START               using GlobalData               using MenuData;initialize the tool locator, memman, and misctools               _TLStartUp              ;tool locator               PushWord #0               _MMStartUp               pla               sta MyID               _MTStartUp               ldx #3               jsr PrepareToDie;get some direct page space for the tool sets               PushLong #0               PushLong #$800               PushWord MyID               PushWord #$C005               PushLong #0               _NewHandle               ldx #$FF               jsr PrepareToDie               pla               sta 0               pla               sta 2               lda [0]               sta 4;init quickdraw               pha               PushWord #ScreenMode    ;mode = 640               PushWord #160               PushWord MyID               _QDStartUp               ldx #4               jsr PrepareToDie;init event manager               lda 4               clc               adc #$300               sta 4               pha               PushWord #20            ;queue size               PushWord #0             ;x clamp left               PushWord #MaxX          ;x clamp right               PushWord #0             ;y clamp top               PushWord #200               PushWord MyID               _EMStartUp               ldx #6               jsr PrepareToDie;load the ram based toolsLoadAgain      PushLong #ToolTable               _LoadTools               bcc ToolsLoaded               cmp #VolNotFound               beq DoMount               sec               ldx #$FE               jsr PrepareToDieDoMount        anop               jsr MountBootDisk               cmp #1               beq LoadAgain               sec               rts;the tools have been loaded. init the window manager, ocntrol manager, etc.ToolsLoaded    anop               PushWord MyID               _WindStartUp               ldx #14               jsr PrepareToDie               PushLong #0               _RefreshDesktop               PushWord MyID               lda 4               clc               adc #$100               sta 4               pha               _CtlStartUp               ldx #16               jsr PrepareToDie               PushWord MyID               lda 4               clc               adc #$100               sta 4               pha               _LEStartUp               ldx #20               jsr PrepareToDie               PushWord MyID           ;dialog manager               _DialogStartUp               ldx #21               jsr PrepareToDie               PushWord MyID               lda 4               clc               adc #$100               sta 4               pha               _MenuStartUp               ldx #15               jsr PrepareToDie               _DeskStartUp               PushLong #0     ;Life Menu               PushLong #LifeMenu               _NewMenu               PushWord #0               _InsertMenu               PushLong #0               PushLong #FileMenu               _NewMenu               PushWord #0               _InsertMenu               PushLong #0               PushLong #AppleMenu               _NewMenu               PushWord #0               _InsertMenu;               PushWord #1               _FixAppleMenu   ;install the NDA's               PushWord #0               _FixMenuBar               pla               _DrawMenuBar               jsr SetUpWindows               _ShowCursor               PushWord MyID               lda 4               clc               adc #$0100               sta 4               pha               _SFStartUp               clc               rts               ENDSetUpWindows   START               using GlobalData               using WindowData               PushLong #0             ;window 1               PushLong #UnivParmBlock               _NewWindow               pla               sta UnivPtr               pla               sta UnivPtr+2               PushLong UnivPtr               _SetPort               PushLong #0               PushLong #AboutWinBlock               _NewWindow               pla               sta AboutWinPtr               pla               sta AboutWinPtr+2               rts               END; event loop this is the sub that interacts with the userEventLoop      START               using GlobalData               using JunkAgain          lda QuitFlag               bne NoMore               PushWord #0               PushWord #$1FFF               PushLong #TaskRecord    ;Point to task record buffer               _TaskMaster               pla             ;is an event available?               beq Again       ;nope               asl a               tax             ;and copy to x               jsr (TaskTable,x)               bra Again               ;keep goingNoMore         rtsTaskTable      anop               dc i'Ignore'            ;0 null               dc i'Ignore'            ;1 mouse down               dc i'Ignore'            ;2 mouse up               dc i'Ignore'            ;3 key down               dc i'Ignore'            ;4 undefined               dc i'Ignore'            ;5 auto-key               dc i'Ignore'            ;6 update               dc i'Ignore'            ;7 undefined               dc i'Ignore'            ;8 activate               dc i'Ignore'            ;9 switch               dc i'Ignore'            ;10 desk acc               dc i'Ignore'            ;11 device driver               dc i'Ignore'            ;12 app               dc i'Ignore'            ;13 app               dc i'Ignore'            ;14 app               dc i'Ignore'            ;15 app               dc i'Ignore'            ;16 in desktop               dc i'DoMenu'            ;17 in system menu bar               dc i'Ignore'            ;18 in system window               dc i'DrawBlox'          ;19 in window content region               dc i'Ignore'            ;20 in drag region               dc i'Ignore'            ;21 in grow box               dc i'Ignore'            ;22 in go-away region               dc i'Ignore'            ;23 in zoom box               dc i'Ignore'            ;24 in info bar               dc i'Ignore'            ;25 in right scroll bar               dc i'Ignore'            ;26 in bottom scroll bar               dc i'Ignore'            ;27 in frame               dc i'Ignore'            ;28 in drop region               ENDIgnore         START               rts               ENDDoUpdate       START               _HideCursor               jsr FixScreen               _ShowCursor               rtl               ENDDrawBlox       START               using ColorTab               using GlobalData               using Buffers               using CursorData               using Junk               lda #$FFFF               sta LastCH               sta LastVC               jsr GetLifeXY               stx XLoc               stx CH               sty YLoc               sty VC               jsr CalcPos               ldy #1               lda StatBuf,x               and #$00FF               beq hmmbugger               ldy #0hmmbugger      tya               sta PaintColor               asl a               sta Thingy               bra Next2NextPaint      anop               PushWord #0               PushWord #0             ;check button #0               _StillDown              ;see if we're still pressed               pla               bne ContPaint               rtsContPaint      jsr GetLifeXY           ;get our LifeXY               stx CH               stx XLoc               sty VC               sty YLoc               lda CH               cmp LastCH               bne Next1               lda VC               cmp LastVC               beq NextPaintNext1          jsr CalcPosNext2          ldy #0               lda StatBuf,x               and #$00FF               beq humshit               ldy #1humshit        tya               cmp PaintColor               beq TheSame             ;don't change population               inc Population               lda PaintColor               cmp #1                  ;currently alive               beq TheSame               dec Population               dec PopulationTheSame        lda StatBuf,x               and #$FF00               ora PaintColor               sta StatBuf,x               _HideCursor               lda PaintColor          ;ColorTable,x               jsr PlotDot               lda CH               pha               lda #12               sta CH               ldx Population          ;print current population               jsr LinPrt              ;the right way               pla               sta CH               _ShowCursor               lda CH               sta LastCH               lda VC               sta LastVC               brl NextPaintQuitPaint      rtsLastCH         dc i2'0'LastVC         dc i2'0'               ENDDoMenu         START               using GlobalData               lda TaskData               and #$00FF               asl a               tax               jsr (ItemTable,x)               PushWord #0               PushWord TaskData+2               _HiliteMenu               rtsItemTable      dc i'DoAbout'               dc i'DoNew'               dc i'DoLoad'               dc i'DoSave'               dc i'DoQuit'               dc i'DoStart'               dc i'DoRandom'               ENDDoQuit         START               using GlobalData               lda #1               sta QuitFlag               rts               ENDDoStart        START               _HideCursor               PushWord #1               _IntSource               jsr LifeRun               LONGA ON               rep #$20               PushWord #0               _IntSource               _ShowCursor               rts               ENDDoNew          START               using Buffers               using Junk               _HideCursorCLR            LDY #0             ; this routine clears out the               TYA                ; to make sure. This routine is only usedCLR1           STA StatBuf,Y     ; once at the beginning of each round.               STA StatBuf+$0200,Y               STA StatBuf+$0400,Y               STA StatBuf+$0600,Y               STA StatBuf+$0800,Y               STA StatBuf+$0A00,Y               STA StatBuf+$0C00,Y               STA StatBuf+$0E00,Y               INY               iny               cpy #$200               BNE CLR1               jsr FixScreen               _ShowCursor               stz Population               lda #12               sta CH               ldx #0               jsr LINPRT               rts               END** This routine stuffs a pixel of color A at horz loc CH line VCPlotDot        START               using SHRAdrTable               using Junk               using ColorTab               phx               phy               asl a               tax               lda ColorTable,x               pha               lda CH               asl a               sta Temp               lda VC               asl a               tay               lda SHRTable,y               clc               adc Temp               tax               pla               sta $E10000,x               sta $E100A0,x               sta $E10140,x               ply               plx               rtsTemp           dc i2'0'               ENDGetLifeXY      START               using GlobalData               PushLong #EventWhere               _GetMouse               lda EventWhere               bpl Top1               lda #0Top1           cmp #175               bcc TopOK               lda #175TopOK          anop               lsr a               lsr a               tayNext           lda EventWhere+2               lsr a               lsr a               tax               rts               END*  Prepare to Die*  Dies if carry is setPrepareToDie   START               bcs RealDeath               rtsRealDeath      pha               PushLong #DeathMsg               _SysFailMgrDeathMsg       str 'Could not handle error '               END*****   Mount Boot DiskMountBootDisk  START               _Set_Prefix SetPrefixParams               _Get_Prefix GetPrefixParams               PushWord #0               PushWord #195               PushWord #30               PushLong #PromptStr               PushLong #VolStr               PushLong #OKStr               PushLong #CancelStr               _TLMountVolume               pla               rtsPromptStr      str 'Please insert the disk.'VolStr         ds 16OKStr          str 'OK'CancelStr      str 'Shutdown'GetPrefixParams dc i'7'               dc i4'VolStr'SetPrefixParams dc i'7'               dc i4'BootStr'BootStr        str '*/'               ENDMenuData       DATAAppleMenu      dc c'>L@\N1X',i1'13'               dc c' LAbout Liphe-816...\N256',i1'13' ; item disabled               dc c'.'FileMenu       dc c'>L File \N2',i1'13'               dc c' LNew\N257*Nn',i1'13'               dc c' LOpen\N258*Oo',i1'13'               dc c' LSave\N259*Ss',i1'13'               dc c' LQuit\N260*Qq',i1'13'               dc c'.'LifeMenu       dc c'>L Life \N3',i1'13'               dc c' LStart\N261*Aa',i1'13'               dc c' LRandomize\N262*Rr',i1'13'               dc c'.'               ENDWindowData     DATAUnivParmBlock  dc i'WinEnd-UnivParmBlock'               dc i2'%0000000000100000'               dc i4'0'        ;title (none)               dc i4'0'        ;WRefCon               dc i'14,0,199,320'               dc i4'0'               dc i2'0'               dc i2'0'               dc i2'200'               dc i2'320'               dc i2'200'               dc i2'320'               dc i2'0,0'     ;pixels to scroll vert, horz               dc i2'0,0'     ;pixels to page vert, horz               dc i4'0'               dc i2'0'               dc i4'0,0'               dc i4'DoUpdate'    ; will be 'FixScreen'               dc i'14,0,199,320'               dc i4'-1'               dc i4'0'WinEnd         anopAboutWinBlock  dc i'WinEnd-UnivParmBlock'               dc i2'%0010000000000000'               dc i4'0'        ;title (none)               dc i4'0'        ;WRefCon               dc i'50,55,120,245'               dc i4'0'               dc i2'0'               dc i2'0'               dc i2'200'               dc i2'320'               dc i2'200'               dc i2'320'               dc i2'0,0'     ;pixels to scroll vert, horz               dc i2'0,0'     ;pixels to page vert, horz               dc i4'0'               dc i2'0'               dc i4'0,0'               dc i4'0'           ; will be 'FixScreen'               dc i'50,55,120,245'               dc i4'-1'               dc i4'0'               ENDSHRAdrTable    DATASHRTable       dc i2'$28C0'    ;14               dc i2'$2B40'    ;18               dc i2'$2DC0'    ;22               dc i2'$3040'    ;26               dc i2'$32C0'    ;30               dc i2'$3540'    ;34               dc i2'$37C0'    ;38               dc i2'$3A40'    ;42               dc i2'$3CC0'    ;46               dc i2'$3F40'    ;50               dc i2'$41C0'    ;54               dc i2'$4440'    ;58               dc i2'$46C0'    ;62               dc i2'$4940'    ;66               dc i2'$4BC0'    ;70               dc i2'$4E40'    ;74               dc i2'$50C0'    ;78               dc i2'$5340'    ;82               dc i2'$55C0'    ;86               dc i2'$5840'    ;90               dc i2'$5AC0'    ;94               dc i2'$5D40'    ;98               dc i2'$5FC0'    ;102               dc i2'$6240'    ;106               dc i2'$64C0'    ;110               dc i2'$6740'    ;114               dc i2'$69C0'    ;118               dc i2'$6C40'    ;122               dc i2'$6EC0'    ;126               dc i2'$7140'    ;130               dc i2'$73C0'    ;134               dc i2'$7640'    ;138               dc i2'$78C0'    ;142               dc i2'$7B40'    ;146               dc i2'$7DC0'    ;150               dc i2'$8040'    ;154               dc i2'$82C0'    ;158               dc i2'$8540'    ;162               dc i2'$87C0'    ;166               dc i2'$8A40'    ;170               dc i2'$8CC0'    ;174               dc i2'$8F40'    ;178               dc i2'$91C0'    ;182               dc i2'$9440'    ;184               dc i2'$96C0'    ;188               dc i2'$9940'    ;192               ENDColorTab       DATAColorTable     dc i2'$FFFF'               dc i2'$1F11'               dc i2'$7F77'               dc i2'$4F44'               dc i2'$0F00'               END